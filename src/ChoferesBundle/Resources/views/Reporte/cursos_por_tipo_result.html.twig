
{% extends 'ChoferesBundle:Layout:layout.html.twig' %}

{% block title %}
Reporte Cursos por tipo
{% endblock %}

{% block menu %}
{{ include('ChoferesBundle:NavBars:navbar.html.twig') }}
{% endblock %}

{% block pageHeader %}
<h1 class="page-title">Reporte Cursos por tipo</h1>
<ol class="breadcrumb">
  <li><a href="{{ path('home') }}">Inicio</a></li>
  <li class="active">Reportes</li>
</ol>
{% endblock %}

{% block page %}
<div id="errorMessage"></div>
<div class="panel panel-primary">
  <div class="panel-heading">
    <h3 class="panel-title">Reporte para cursos con fecha de inicio entre <b>{{ fechaInicioDesde }}</b> y <b>{{ fechaInicioHasta }}</b></h3>
  </div>
</div>

<div class="panel panel-primary">
  <div class="panel-body">
    <h4 class="example-title">
      Resumen
    </h4>
    <hr>
  {% if (cursos|length) > 0 %}
    <div class="row">
      <div class="col-md-3"><p>Total Cursos:</p></div>
      <div class="col-md-3"><h5><strong>{{ cursos|length }}</strong> cursos.</h5></div>
    </div>
    <div class="row">
      <div class="col-md-3"><p>Total de alumnos</p></div>
      <div class="col-md-3"><h5><strong>{{ totalAlumnos }}</strong> alumnos.</h5></div>
    </div>
    <div class="row">
      <div class="col-md-3"><p>Monto total a recaudar ($):</p></div>
      <div class="col-md-3"><h5><strong>{{ montoTotal }}</strong> $</h5></div>
    </div>
    <div class="row">
      <div class="col-md-3"><p>Monto total recaudado ($):</p></div>
      <div class="col-md-3"><h5><strong>{{ montoRecaudado }}</strong> $</h5></div>
    </div>
  </div>
  {% else %}
    <h3 class="example-title">No hay cursos que cumplan los criterios ingresados.</h3>
    </div>
  {% endif %}
</div>

{% if (cursos|length) > 0 %}
  <div class="panel panel-primary">
    <div class="panel-body">
      <h4 class="example-title">
        Detalle por tipo de curso
      </h4>
      <hr>
      <table class="table table-bordered table-hover table-striped">
        <thead>
          <tr>
            <th>Tipo de curso</th>
            <th>Cantidad de cursos</th>
            <th>Cantidad de alumnos</th>
            <th>Monto total a recaudar ($)</th>
            <th>Monto total recaudado ($)</th>
          </tr>
        </thead>
        <tbody>
          {% for tipoCurso in dataPorTipoCurso %}
            <tr class="gradeA">
              <td>{{ tipoCurso.tipo }}</td>
              <td>{{ tipoCurso.cantCursos }}</td>
              <td>{{ tipoCurso.cantAlumnos }}</td>
              <td>{{ tipoCurso.montoTotal }} $</td>
              <td>{{ tipoCurso.montoRecaudado }} $</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

{% if (cursos|length) > 0 %}
  <div class="panel panel-primary">
    <div class="panel-body">
      <div class="row">
        <div class="col-sm-2 col-md-2 margin-top-10">
          <h4 class="example-title">
            Detalle de cursos
          </h4>
        </div>
        <div class="col-sm-2 col-md-2">
          <button id="exportar-excel" class="btn btn-primary" data-href="{{ path('reporte_cursos_por_tipo_excel') }}" data-from="{{ fechaInicioDesde }}" data-to="{{ fechaInicioHasta }}">
          Exportar a Excel
        </button>
        </div>
        <div class="col-sm-1 col-md-1 margin-top-20">
          <div class="loader-inner ball-spin-fade-loader"></div>
        </div>
      </div>
      <hr>
      <table class="table table-bordered table-hover table-striped">
        <thead>
          <tr>
            <th>Tipo de curso</th>
            <th>Id</th>
            <th>Fecha de inicio</th>
            <th>Fecha de fin</th>
            <th>Prestador</th>
            <th>Nro de TRI</th>
            <th>Estado</th>
            <th>Sede</th>
            <th>Monto a recaudar ($)</th>
            <th>Monto recaudado ($)</th>
          </tr>
        </thead>
        <tbody>
          {% for curso in cursos %}
          <tr class="gradeA">
            <td>{{ curso.tipocurso }}</td>
            <td><a href="{{ path('curso_show', {'id': curso.id}) }}">{{ curso.id }}</a></td>
            <td>{{ curso.fechaInicio|date("d/m/Y") }}</td>
            <td>{{ curso.fechaFin|date("d/m/Y") }}</td>
            <td>{{ curso.prestador }}</td>
            <td>{{ curso.codigo }}</td>
            <td>{{ curso.estado }}</td>
            <td>{{ curso.sede }}</td>
            <td>{{ curso.montoTotal }} $</td>
            <td>{{ curso.montoRecaudado }} $</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block javascript %}
<script>
(function(window, document, $) {
  var $loader           = $('.loader-inner');
  var $errorDiv         = $('#errorMessage');
  var $exportarExcelBtn = $('#exportar-excel');
  $loader.hide();
  $loader.loaders();
  
  $exportarExcelBtn.on("click",function(e) {
    var $form = $('<form></form>');
    $form.append('<input type="text" name="from" value="' + $(this).data('from') + '" />');
    $form.append('<input type="text" name="to" value="' + $(this).data('to') + '" />');

    $.fileDownload($(this).data('href'), {
      prepareCallback: function(url) {
        $errorDiv.empty();
        $exportarExcelBtn.prop("disabled", true);
        $loader.show();
      },
      successCallback: function(url) {
        $loader.hide();
        $exportarExcelBtn.prop("disabled", false);
      },
      failCallback: function(responseHtml, url, error) {
        $loader.hide();
        $exportarExcelBtn.prop("disabled", false);
        var jsonResult = $.parseJSON(responseHtml.substring(responseHtml.indexOf("{"), responseHtml.lastIndexOf("}") + 1));
        $('<div/>', {
          'class': 'alert ng-isolate-scope alert-danger alert-dismissible',
          'html': '<div ><span class="ng-binding ng-scope">' + jsonResult.message + '</span></div>',
        }).appendTo($errorDiv);
      },
      httpMethod: "POST",
      data: $form.serialize()
    });

    return false;
  });
})(window, document, jQuery);
</script>
{% endblock %}
